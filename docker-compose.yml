name: n8n-nca-minio
services:
  init-permissions:
    image: busybox:latest
    container_name: init-permissions
    command: >
      sh -c "
      mkdir -p /n8n-data /minio-data /files /files/clips /FINAL/YT_Clips &&
      chown -R 1000:1000 /n8n-data /files /FINAL &&
      chown -R 1000:1000 /minio-data &&
      echo 'Permissions set successfully'
      "
    volumes:
      - type: bind
        source: ./n8n
        target: /n8n-data
      - type: bind
        source: ./minio/data
        target: /minio-data
      - type: bind
        source: ./ffmpeg/files
        target: /files
      - type: bind
        source: ./FINAL
        target: /FINAL
    restart: "no"
  minio:
    cpu_shares: 50
    command:
      - server
      - /data
      - --console-address
      - :9001
    container_name: minio
    depends_on:
      init-permissions:
        condition: service_completed_successfully
        required: true
    deploy:
      resources:
        limits:
          memory: "4G"
        reservations:
          devices: []
    environment:
      - MINIO_ROOT_PASSWORD=minioadmin
      - MINIO_ROOT_USER=minioadmin
    image: minio/minio:latest
    labels:
      icon: https://cdn.jsdelivr.net/gh/IceWhaleTech/CasaOS-AppStore@main/Apps/n8n/icon.png
    ports:
      - target: 9000
        published: "9000"
        protocol: tcp
      - target: 9001
        published: "9001"
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: bind
        source: ./minio/data
        target: /data
    devices: []
    cap_add: []
    networks:
      - n8network
    privileged: false
  minio-init:
    cpu_shares: 10
    command: []
    container_name: minio-init
    depends_on:
      minio:
        condition: service_started
        required: true
    deploy:
      resources:
        limits:
          memory: "4G"
        reservations:
          devices: []
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo "Waiting for MinIO to be ready..."
        i=1
        while [ $i -le 30 ]; do
          if /usr/bin/mc alias set myminio http://minio:9000 minioadmin minioadmin; then
            echo "MinIO is ready, setting up bucket..."
            /usr/bin/mc mb myminio/nca-toolkit --ignore-existing
            /usr/bin/mc anonymous set public myminio/nca-toolkit
            echo 'MinIO bucket nca-toolkit created and configured as public'
            exit 0
          else
            echo "Attempt $i: MinIO not ready yet, waiting 2 seconds..."
            sleep 2
            i=$((i + 1))
          fi
        done
        echo "Failed to connect to MinIO after 30 attempts"
        exit 1
    image: minio/mc:latest
    labels:
      icon: https://cdn.jsdelivr.net/gh/IceWhaleTech/CasaOS-AppStore@main/Apps/n8n/icon.png
    restart: "no"
    ports: []
    volumes: []
    devices: []
    cap_add: []
    environment: []
    networks:
      - n8network
    privileged: false
  n8n:
    cpu_shares: 70
    command: []
    container_name: n8n
    depends_on:
      init-permissions:
        condition: service_completed_successfully
        required: true
    deploy:
      resources:
        limits:
          memory: "4G"
        reservations:
          devices: []
    environment:
      - GENERIC_TIMEZONE=UTC
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_SECURE_COOKIE=false
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:5678/
    image: docker.n8n.io/n8nio/n8n:latest
    labels:
      icon: https://cdn.jsdelivr.net/gh/IceWhaleTech/CasaOS-AppStore@main/Apps/n8n/icon.png
    ports:
      - target: 5678
        published: "5678"
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: bind
        source: ./n8n
        target: /home/node/.n8n
      - type: bind
        source: ./ffmpeg/files
        target: /files
      - type: bind
        source: ./FINAL
        target: /FINAL
    devices: []
    cap_add: []
    networks:
      - n8network
    privileged: false
  nca-toolkit:
    cpu_shares: 90
    command: []
    container_name: nca-toolkit
    depends_on:
      minio:
        condition: service_started
        required: true
      minio-init:
        condition: service_started
        required: true
    deploy:
      resources:
        limits:
          memory: "4G"
        reservations:
          devices: []
    environment:
      - API_KEY=your_secure_api_key_here
      - GUNICORN_TIMEOUT=600
      - GUNICORN_WORKERS=4
      - LOCAL_STORAGE_PATH=/tmp
      - MAX_QUEUE_LENGTH=10
      - S3_ACCESS_KEY=minioadmin
      - S3_BUCKET_NAME=nca-toolkit
      - S3_ENDPOINT_URL=http://minio:9000
      - S3_REGION=us-east-1
      - S3_SECRET_KEY=minioadmin
    image: stephengpope/no-code-architects-toolkit:latest
    labels:
      icon: https://cdn.jsdelivr.net/gh/IceWhaleTech/CasaOS-AppStore@main/Apps/n8n/icon.png
    ports:
      - target: 8080
        published: "8082"
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: bind
        source: ./ffmpeg/files
        target: /tmp
      - type: bind
        source: ./FINAL
        target: /FINAL
    devices: []
    cap_add: []
    networks:
      - n8network
    privileged: false
  autocrop:
    build:
      context: ./autocrop
      dockerfile: Dockerfile
    container_name: autocrop
    restart: unless-stopped
    environment:
      - S3_ENDPOINT_URL=http://minio:9000
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_BUCKET_NAME=nca-toolkit
    ports:
      - target: 8083
        published: "8083"
        protocol: tcp
    networks:
      - n8network
    privileged: false
  minio-organizer:
    build:
      context: ./minio-organizer
      dockerfile: Dockerfile
    container_name: minio-organizer
    restart: unless-stopped
    environment:
      - S3_ENDPOINT_URL=http://minio:9000
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_BUCKET_NAME=nca-toolkit
    ports:
      - target: 8084
        published: "8084"
        protocol: tcp
    networks:
      - n8network
    privileged: false
networks:
  n8network:
    name: n8n-nca-minio_n8network
    driver: bridge
x-casaos:
  author: self
  category: self
  hostname: ""
  icon: https://cdn.jsdelivr.net/gh/IceWhaleTech/CasaOS-AppStore@main/Apps/n8n/icon.png
  index: /
  is_uncontrolled: false
  port_map: "5678"
  scheme: http
  store_app_id: n8n-nca-minio
  title:
    custom: ""
    en_us: n8n with NCA Toolkit and MinIO